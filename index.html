<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Injetáveis Mara — Protocolos por Fármaco (Acessível)</title>

    <style>
      /* ========= Paleta (Outono Escuro) ========= */
      :root {
        --bg: #14110e;
        --panel: #1d1916;
        --ink: #f1ece6;
        --muted: #c9b9a7;
        --accent: #c67a2e;
        --accent-contrast: #f0a84e;
        --line: #3a342f;
        --danger: #d65f4a;
        --ok: #7fb07c;

        --radius: 12px;
        --radius-sm: 10px;
        --space-1: 6px;
        --space-2: 10px;
        --space-3: 14px;
        --space-4: 18px;

        --focus-ring: 2px solid var(--accent-contrast);
        --target-min: 44px;
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        margin: 0;
        height: 100%;
        background: var(--bg);
        color: var(--ink);
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Helvetica,
          Arial,
          "Apple Color Emoji",
          "Segoe UI Emoji";
        line-height: 1.5;
        -webkit-text-size-adjust: 100%;
        text-size-adjust: 100%;
      }

      .skip-link {
        position: absolute;
        left: -9999px;
        top: auto;
        width: 1px;
        height: 1px;
        overflow: hidden;
      }
      .skip-link:focus {
        position: static;
        width: auto;
        height: auto;
        margin: var(--space-2);
        padding: var(--space-2) var(--space-3);
        background: var(--accent);
        color: #1a1208;
        border-radius: var(--radius-sm);
        outline: var(--focus-ring);
      }

      header {
        border-bottom: 1px solid var(--line);
        padding: var(--space-3) var(--space-3);
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--space-3);
      }
      .panel {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: var(--radius);
        padding: var(--space-3);
      }

      h1,
      h2,
      h3 {
        margin: 0 0 var(--space-2) 0;
      }
      p {
        margin: 0 0 var(--space-2) 0;
        color: var(--muted);
      }
      label {
        display: block;
        font-size: 0.95rem;
        color: var(--muted);
        margin-bottom: 4px;
      }

      input[type="text"],
      input[type="number"],
      select,
      textarea {
        width: 100%;
        border-radius: var(--radius-sm);
        border: 1px solid var(--line);
        background: #100e0c;
        color: var(--ink);
        padding: 12px;
        font-size: 1rem;
        min-height: 44px;
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: var(--focus-ring);
        outline-offset: 2px;
      }

      .btn {
        background: var(--accent);
        border: none;
        color: #1a1208;
        padding: 12px 16px;
        border-radius: var(--radius-sm);
        font-weight: 600;
        cursor: pointer;
        font-size: 1rem;
        min-height: var(--target-min);
        min-width: 44px;
      }
      .btn.secondary {
        background: transparent;
        color: var(--ink);
        border: 1px solid var(--line);
      }
      .btn:hover,
      .btn:focus {
        background: var(--accent-contrast);
        outline: var(--focus-ring);
        outline-offset: 2px;
      }
      .btn[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .grid {
        display: grid;
        gap: var(--space-3);
      }
      .row {
        display: flex;
        gap: var(--space-3);
        flex-wrap: wrap;
        align-items: flex-end;
      }
      .col {
        flex: 1 1 260px;
        min-width: 260px;
      }

      .pill {
        display: inline-block;
        padding: 4px 10px;
        border: 1px solid var(--line);
        border-radius: 999px;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .issues {
        margin-top: var(--space-2);
        border: 1px solid var(--line);
        border-radius: var(--radius-sm);
        background: #191512;
        padding: var(--space-2);
      }
      .issues h3 {
        margin: 0 0 6px 0;
        color: var(--danger);
      }

      .table-wrap {
        margin-top: var(--space-3);
        overflow-x: auto;
        border-radius: var(--radius-sm);
        border: 1px solid var(--line);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: #120f0d;
      }
      thead th {
        position: sticky;
        top: 0;
        background: #1a1613;
        border-bottom: 1px solid var(--line);
      }
      th,
      td {
        border: 1px solid var(--line);
        padding: 10px;
        vertical-align: top;
        font-size: 0.95rem;
      }
      th:nth-child(1),
      td:nth-child(1) {
        width: 72px;
        text-align: center;
      }
      td:empty::after {
        content: "—";
        color: var(--muted);
      }

      .check {
        inline-size: 24px;
        block-size: 24px;
        border: 2px solid var(--muted);
        border-radius: 4px;
        display: inline-grid;
        place-items: center;
        user-select: none;
      }
      .check[aria-checked="true"] {
        background: var(--ok);
        border-color: var(--ok);
      }
      .check:focus {
        outline: var(--focus-ring);
        outline-offset: 2px;
      }

      .drug-table {
        width: 100%;
        border-collapse: collapse;
        background: #15120f;
        border: 1px solid var(--line);
        border-radius: var(--radius-sm);
        overflow: hidden;
      }
      .drug-table th,
      .drug-table td {
        border: 1px solid var(--line);
        padding: 8px 10px;
      }
      .drug-actions {
        display: flex;
        gap: 8px;
      }

      .proto-box {
        background: #181410;
        border: 1px dashed var(--line);
        border-radius: 8px;
        padding: 10px;
        margin-top: 8px;
      }
      .proto-grid {
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .help {
        background: #191512;
        border: 1px solid var(--line);
        border-radius: var(--radius);
        padding: var(--space-3);
      }

      @media print {
        @page {
          size: A4 landscape;
          margin: 12mm;
        }
        body {
          background: #fff !important;
          color: #000 !important;
        }
        header,
        .screen-only,
        .issues,
        .no-print,
        .help {
          display: none !important;
        }
        .print-area {
          display: block !important;
        }
        .panel {
          border: none !important;
          box-shadow: none !important;
          padding: 0 !important;
          background: transparent !important;
        }
        table,
        th,
        td {
          border-color: #000 !important;
          color: #000 !important;
          background: #fff !important;
        }
        thead {
          display: table-header-group;
        }
        tr {
          page-break-inside: avoid;
        }
        .print-title {
          display: block !important;
          margin: 0 0 8px 0;
          font-size: 1.1rem;
          font-weight: 700;
          color: #000 !important;
        }
      }
      @media (prefers-reduced-motion: reduce) {
        * {
          scroll-behavior: auto !important;
          animation: none !important;
          transition: none !important;
        }
      }
    </style>
  </head>
  <body>
    <a class="skip-link" href="#main">Pular para o conteúdo principal</a>

    <header role="banner">
      <div class="container">
        <h1>Injetáveis Mara — Protocolos por Fármaco</h1>
        <p class="screen-only">
          Cada fármaco tem seu próprio ritmo/padrão. A impressão mostra apenas
          título e tabela.
        </p>
      </div>
    </header>

    <main id="main" class="container" role="main">
      <section class="panel" aria-describedby="legend">
        <p id="legend" class="screen-only">
          Defina o título (opcional) e cadastre fármacos com seus protocolos
          individuais.
        </p>

        <div class="grid" style="gap: var(--space-4)">
          <!-- Título opcional -->
          <div class="row">
            <div class="col" style="flex: 1 1 480px">
              <label for="titleInput"
                >Título da tabela (opcional; aparece na impressão)</label
              >
              <input
                type="text"
                id="titleInput"
                placeholder="Ex.: Protocolo de indução — Biológico X"
                aria-describedby="titleHelp"
                maxlength="120"
              />
              <small id="titleHelp" class="screen-only"
                >Máx. 120 caracteres.</small
              >
            </div>
          </div>

          <!-- Fármacos (com protocolo por linha) -->
          <div>
            <div class="pill" aria-hidden="true">Fármacos e protocolos</div>
            <div class="row">
              <div class="col" style="flex: 1 1 100%">
                <table class="drug-table" aria-label="Tabela de fármacos">
                  <thead>
                    <tr>
                      <th scope="col">Nome</th>
                      <th scope="col">Dose</th>
                      <th scope="col">Via</th>
                      <th scope="col">Observações</th>
                      <th scope="col">Protocolo</th>
                      <th scope="col">Ações</th>
                    </tr>
                  </thead>
                  <tbody id="drugBody"></tbody>
                </table>
                <div class="row" style="margin-top: var(--space-2)">
                  <button class="btn" id="btnAddDrug" type="button">
                    + Adicionar fármaco
                  </button>
                  <button
                    class="btn secondary"
                    id="btnClearDrugs"
                    type="button"
                  >
                    Limpar fármacos
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Ações -->
          <div class="row">
            <button
              class="btn"
              id="btnGenerate"
              type="button"
              aria-label="Gerar tabela"
            >
              Gerar tabela
            </button>
            <button
              class="btn secondary"
              id="btnPrint"
              type="button"
              aria-label="Imprimir tabela"
            >
              Imprimir
            </button>
            <button
              class="btn secondary"
              id="btnReset"
              type="button"
              aria-label="Limpar tudo"
            >
              Limpar tudo
            </button>
          </div>

          <!-- Pendências -->
          <div
            id="issues"
            class="issues screen-only"
            style="display: none"
            aria-live="polite"
            aria-atomic="true"
          >
            <h3>Pendências para confirmação</h3>
            <ul id="issuesList"></ul>
          </div>

          <!-- Área impressa -->
          <div class="print-area">
            <h2 id="printTitle" class="print-title" aria-hidden="true"></h2>
            <div class="table-wrap">
              <table
                id="resultTable"
                aria-label="Calendário consolidado por marcos"
              >
                <thead>
                  <tr>
                    <th scope="col">Feito</th>
                    <th scope="col">Semana/Dose</th>
                    <th scope="col">Medicamentos a aplicar (via ao lado)</th>
                    <th scope="col">Observações</th>
                  </tr>
                </thead>
                <tbody id="resultBody"></tbody>
              </table>
            </div>
          </div>

          <!-- Ajuda -->
          <div class="help screen-only">
            <h3>Como usar — rápido</h3>
            <ol>
              <li>(Opcional) Digite um <strong>título</strong>.</li>
              <li>
                Para cada <strong>fármaco</strong>, preencha Nome/Dose/Via/Obs e
                escolha um <strong>Protocolo</strong> na própria linha (com os
                campos X, N, Y, etc.).
              </li>
              <li>
                Clique em <strong>Gerar tabela</strong>. Os marcos iguais (“Dose
                1 (Dia 0)”, “Semana 3”…) são <strong>agregados</strong> e os
                fármacos são mostrados juntos.
              </li>
              <li>Use <strong>Imprimir</strong> para folha A4 paisagem.</li>
            </ol>
          </div>
        </div>
      </section>
    </main>

    <script>
      (function () {
        "use strict";

        /* =========================
         * Utilidades puras (SRP)
         * ========================= */
        const VIA_LABEL = Object.freeze({
          EV: "endovenosa",
          IM: "intramuscular",
          SC: "subcutânea",
          VO: "via oral",
        });

        function normalizeDoseSpacing(dose) {
          if (!dose) return "";
          return String(dose)
            .replace(/(\d+)\.(\d+)/g, "$1,$2")
            .replace(/\s*(mg|g|mL|mcg|µg|UI|U)\b/gi, " $1")
            .trim();
        }
        function uniqClean(arr) {
          return [
            ...new Set(
              (arr || []).map((s) => String(s).trim()).filter(Boolean),
            ),
          ];
        }
        function parsePositiveInt(v) {
          const n = parseInt(String(v).trim(), 10);
          return Number.isFinite(n) && n > 0 ? n : null;
        }

        /* ---------- Geradores de rótulos ---------- */
        function labels_daily_n_days(n) {
          const out = [];
          for (let i = 1; i <= n; i++) out.push(`Dose ${i} (Dia ${i - 1})`);
          return out;
        }
        function labels_daily_n_weeks(n) {
          const out = [];
          for (let i = 1; i <= n * 7; i++) out.push(`Dose ${i} (Dia ${i - 1})`);
          return out;
        }
        function labels_weekly_n_weeks(n) {
          const out = [];
          for (let i = 1; i <= n; i++) out.push(`Semana ${i}`);
          return out;
        }
        function labels_weekly_n_months(n) {
          const totalWeeks = n * 4;
          const out = [];
          for (let w = 1; w <= totalWeeks; w++) out.push(`Semana ${w}`);
          return out;
        }
        function labels_monthly_n_months(n) {
          const out = [];
          for (let i = 1; i <= n; i++) out.push(`Dose ${i}`);
          return out;
        }
        function labels_every_x_days_n_doses(x, n) {
          const out = [];
          for (let i = 1; i <= n; i++)
            out.push(`Dose ${i} (Dia ${(i - 1) * x})`);
          return out;
        }
        function labels_every_x_days_y_weeks(x, y) {
          const totalDays = y * 7;
          const out = [];
          let day = 0,
            i = 1;
          while (day <= totalDays - 1) {
            out.push(`Dose ${i} (Dia ${day})`);
            day += x;
            i++;
          }
          return out;
        }
        function labels_every_x_days_y_months(x, y) {
          const totalDays = y * 30;
          const out = [];
          let day = 0,
            i = 1;
          while (day <= totalDays - 1) {
            out.push(`Dose ${i} (Dia ${day})`);
            day += x;
            i++;
          }
          return out;
        }
        function labels_every_x_weeks_y_months(x, y) {
          const totalWeeks = y * 4;
          const out = [];
          for (let w = 1; w <= totalWeeks; w += x) out.push(`Semana ${w}`);
          return out;
        }
        function labels_every_x_months_n_doses(x, n) {
          const out = [];
          for (let i = 1; i <= n; i++) out.push(`Dose ${i}`);
          return out;
        }
        function labels_n_doses_n_days(n, p) {
          const out = [];
          if (n <= 0) return out;
          if (n === 1) return ["Dose 1 (Dia 0)"];
          const step = Math.max(1, Math.floor((p - 1) / (n - 1)));
          let day = 0;
          for (let i = 1; i <= n; i++) {
            out.push(`Dose ${i} (Dia ${day})`);
            day += step;
          }
          return out;
        }
        function labels_n_doses_n_weeks(n, p) {
          return labels_n_doses_n_days(n, p * 7);
        }
        function labels_n_doses_3_months(n) {
          return labels_n_doses_n_days(n, 3 * 30);
        }
        function labels_n_doses_n_months(n, p) {
          return labels_n_doses_n_days(n, p * 30);
        }
        function labels_days_0_14_28() {
          return ["Dose 1 (Dia 0)", "Dose 2 (Dia 14)", "Dose 3 (Dia 28)"];
        }
        function labels_days_0_7_21_35() {
          return [
            "Dose 1 (Dia 0)",
            "Dose 2 (Dia 7)",
            "Dose 3 (Dia 21)",
            "Dose 4 (Dia 35)",
          ];
        }
        function labels_days_custom(list) {
          const nums = String(list)
            .split(/[,; ]+/)
            .map((x) => x.trim())
            .filter(Boolean)
            .map((x) => parseInt(x, 10))
            .filter((n) => Number.isFinite(n));
          return nums.map((d, i) => `Dose ${i + 1} (Dia ${d})`);
        }
        function labels_daily_x_then_weekly_y(x, y) {
          const part1 = labels_every_x_days_n_doses(1, x);
          const part2 = labels_weekly_n_weeks(y);
          return {
            blocks: [
              { type: "DIA", labels: part1 },
              { type: "SEMANA", labels: part2 },
            ],
          };
        }
        function labels_weekly_x_then_monthly_y(x, y) {
          const part1 = labels_weekly_n_weeks(x);
          const part2 = labels_monthly_n_months(y);
          return {
            blocks: [
              { type: "SEMANA", labels: part1 },
              { type: "DOSE", labels: part2 },
            ],
          };
        }
        function labels_every_x_days_until_n_doses(x, n) {
          return labels_every_x_days_n_doses(x, n);
        }

        /* =========================
         * DOM helpers
         * ========================= */
        const $ = (s) => document.querySelector(s);
        const titleInput = $("#titleInput");
        const printTitle = $("#printTitle");
        const drugBody = $("#drugBody");
        const resultBody = $("#resultBody");
        const issuesBox = $("#issues");
        const issuesList = $("#issuesList");

        function save(key, val) {
          try {
            localStorage.setItem(key, JSON.stringify(val));
          } catch {}
        }
        function load(key, fallback) {
          try {
            const v = localStorage.getItem(key);
            return v ? JSON.parse(v) : fallback;
          } catch {
            return fallback;
          }
        }

        /* =========================
         * Título (impressão)
         * ========================= */
        function syncTitle() {
          const t = (titleInput.value || "").trim();
          if (t) {
            printTitle.textContent = t;
            printTitle.setAttribute("aria-hidden", "false");
            printTitle.style.display = "";
          } else {
            printTitle.textContent = "";
            printTitle.setAttribute("aria-hidden", "true");
            printTitle.style.display = "none";
          }
          save("mara_title", t);
        }
        titleInput.addEventListener("input", syncTitle);
        (function restoreTitle() {
          const t = load("mara_title", "");
          titleInput.value = t || "";
          syncTitle();
        })();

        /* =========================
         * Templates de campos do Protocolo
         * ========================= */
        const fieldTemplates = Object.freeze({
          // Frequência fixa
          daily_n_days: [
            {
              key: "n",
              label: "N (dias)",
              type: "number",
              min: 1,
              step: 1,
              placeholder: "Ex.: 7",
            },
          ],
          daily_n_weeks: [
            {
              key: "n",
              label: "N (semanas)",
              type: "number",
              min: 1,
              step: 1,
              placeholder: "Ex.: 4",
            },
          ],
          weekly_n_weeks: [
            {
              key: "n",
              label: "N (semanas)",
              type: "number",
              min: 1,
              step: 1,
              placeholder: "Ex.: 4",
            },
          ],
          weekly_n_months: [
            {
              key: "n",
              label: "N (meses)",
              type: "number",
              min: 1,
              step: 1,
              placeholder: "Ex.: 3",
            },
          ],
          monthly_n_months: [
            {
              key: "n",
              label: "N (meses)",
              type: "number",
              min: 1,
              step: 1,
              placeholder: "Ex.: 3",
            },
          ],
          // Intervalos regulares
          every_x_days_n_doses: [
            { key: "x", label: "X (dias)", type: "number", min: 1, step: 1 },
            { key: "n", label: "N (doses)", type: "number", min: 1, step: 1 },
          ],
          every_x_days_y_weeks: [
            { key: "x", label: "X (dias)", type: "number", min: 1, step: 1 },
            { key: "y", label: "Y (semanas)", type: "number", min: 1, step: 1 },
          ],
          every_x_days_y_months: [
            { key: "x", label: "X (dias)", type: "number", min: 1, step: 1 },
            { key: "y", label: "Y (meses)", type: "number", min: 1, step: 1 },
          ],
          every_x_weeks_y_months: [
            { key: "x", label: "X (semanas)", type: "number", min: 1, step: 1 },
            { key: "y", label: "Y (meses)", type: "number", min: 1, step: 1 },
          ],
          every_x_months_n_doses: [
            { key: "x", label: "X (meses)", type: "number", min: 1, step: 1 },
            { key: "n", label: "N (doses)", type: "number", min: 1, step: 1 },
          ],
          // Doses totais
          n_doses_n_days: [
            { key: "n", label: "N (doses)", type: "number", min: 1, step: 1 },
            {
              key: "p",
              label: "Período (dias)",
              type: "number",
              min: 1,
              step: 1,
            },
          ],
          n_doses_n_weeks: [
            { key: "n", label: "N (doses)", type: "number", min: 1, step: 1 },
            {
              key: "p",
              label: "Período (semanas)",
              type: "number",
              min: 1,
              step: 1,
            },
          ],
          n_doses_3_months: [
            { key: "n", label: "N (doses)", type: "number", min: 1, step: 1 },
          ],
          n_doses_n_months: [
            { key: "n", label: "N (doses)", type: "number", min: 1, step: 1 },
            {
              key: "p",
              label: "Período (meses)",
              type: "number",
              min: 1,
              step: 1,
            },
          ],
          // Dias específicos
          days_0_14_28: [],
          days_0_7_21_35: [],
          days_custom: [
            {
              key: "list",
              label: "Dias (0, 14, 28...)",
              type: "text",
              placeholder: "Ex.: 0, 7, 21, 35",
            },
          ],
          // Avançadas
          daily_x_then_weekly_y: [
            {
              key: "x",
              label: "X (dias — diário)",
              type: "number",
              min: 1,
              step: 1,
            },
            {
              key: "y",
              label: "Y (semanas — semanal)",
              type: "number",
              min: 1,
              step: 1,
            },
          ],
          weekly_x_then_monthly_y: [
            {
              key: "x",
              label: "X (semanas — semanal)",
              type: "number",
              min: 1,
              step: 1,
            },
            {
              key: "y",
              label: "Y (meses — mensal)",
              type: "number",
              min: 1,
              step: 1,
            },
          ],
          every_x_days_until_n_doses: [
            { key: "x", label: "X (dias)", type: "number", min: 1, step: 1 },
            { key: "n", label: "N (doses)", type: "number", min: 1, step: 1 },
          ],
        });

        const patternOptionsHTML = `
          <optgroup label="Frequência fixa">
            <option value="daily_n_days">Diário por N dias</option>
            <option value="daily_n_weeks">Diário por N semanas</option>
            <option value="weekly_n_weeks">Semanal por N semanas</option>
            <option value="weekly_n_months">Semanal por N meses</option>
            <option value="monthly_n_months">Mensal por N meses</option>
          </optgroup>
          <optgroup label="Intervalos regulares">
            <option value="every_x_days_n_doses">De X em X dias por N doses</option>
            <option value="every_x_days_y_weeks">De X em X dias por Y semanas</option>
            <option value="every_x_days_y_months">De X em X dias por Y meses</option>
            <option value="every_x_weeks_y_months">A cada X semanas por Y meses</option>
            <option value="every_x_months_n_doses">A cada X meses por N doses</option>
          </optgroup>
          <optgroup label="Doses totais em período">
            <option value="n_doses_n_days">N doses em N dias</option>
            <option value="n_doses_n_weeks">N doses em N semanas</option>
            <option value="n_doses_3_months">N doses em 3 meses</option>
            <option value="n_doses_n_months">N doses em N meses</option>
          </optgroup>
          <optgroup label="Dias específicos">
            <option value="days_0_14_28">Dias 0/14/28</option>
            <option value="days_0_7_21_35">Dias 0/7/21/35</option>
            <option value="days_custom">Dias personalizados</option>
          </optgroup>
          <optgroup label="Avançada (sequenciais/compostas)">
            <option value="daily_x_then_weekly_y">Diário por X dias, depois semanal por Y semanas</option>
            <option value="weekly_x_then_monthly_y">Semanal por X semanas, depois mensal por Y meses</option>
            <option value="every_x_days_until_n_doses">A cada X dias até N doses</option>
          </optgroup>
        `;

        /* =========================
         * Linha de fármaco
         * ========================= */
        function renderPatternFields(container, key) {
          container.innerHTML = "";
          const fields = fieldTemplates[key] || [];
          const grid = document.createElement("div");
          grid.className = "proto-grid";
          fields.forEach((f) => {
            const id = `pf_${key}_${f.key}_${Math.random().toString(36).slice(2, 7)}`;
            const extra =
              f.type === "number"
                ? `inputmode="numeric" min="${f.min || 1}" step="${f.step || 1}"`
                : "";
            const wrap = document.createElement("div");
            wrap.innerHTML = `
              <label for="${id}">${f.label}</label>
              <input ${extra} type="${f.type}" id="${id}" data-key="${f.key}" placeholder="${f.placeholder || ""}" />
            `;
            grid.appendChild(wrap);
          });
          container.appendChild(grid);
        }

        function addDrugRow(drug) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><input type="text" class="drug-name" placeholder="Ex.: Infliximabe" value="${drug?.name || ""}" aria-label="Nome do fármaco"></td>
            <td><input type="text" class="drug-dose" placeholder="Ex.: 600 mg" value="${drug?.dose || ""}" aria-label="Dose"></td>
            <td>
              <label class="screen-only" for="">Via</label>
              <select class="drug-via" aria-label="Via">
                <option value="EV"${drug?.via === "EV" ? " selected" : ""}>EV — endovenosa</option>
                <option value="IM"${drug?.via === "IM" ? " selected" : ""}>IM — intramuscular</option>
                <option value="SC"${drug?.via === "SC" ? " selected" : ""}>SC — subcutânea</option>
                <option value="VO"${drug?.via === "VO" ? " selected" : ""}>VO — via oral</option>
              </select>
            </td>
            <td><input type="text" class="drug-obs" placeholder="Ex.: diluir em 250 mL NaCl 0,9%; infundir 2 h; Premedicação: ..." value="${drug?.obs || ""}" aria-label="Observações"></td>
            <td>
              <div class="proto-box">
                <label for="">Protocolo (individual)</label>
                <select class="drug-pattern" aria-label="Padrão de protocolo">
                  ${patternOptionsHTML}
                </select>
                <div class="drug-pattern-fields" style="margin-top:8px"></div>
              </div>
            </td>
            <td>
              <div class="drug-actions">
                <button class="btn secondary btn-dup" type="button" title="Duplicar fármaco">Duplicar</button>
                <button class="btn secondary btn-del" type="button" title="Remover fármaco">Remover</button>
              </div>
            </td>
          `;
          drugBody.appendChild(tr);

          const patternSelect = tr.querySelector(".drug-pattern");
          const fieldsBox = tr.querySelector(".drug-pattern-fields");

          // estado inicial
          patternSelect.value = drug?.pattern || "daily_n_days";
          renderPatternFields(fieldsBox, patternSelect.value);

          // preencher campos se houver
          if (drug?.patternValues) {
            Object.entries(drug.patternValues).forEach(([k, v]) => {
              const el = fieldsBox.querySelector(`[data-key="${k}"]`);
              if (el) el.value = v;
            });
          }

          patternSelect.addEventListener("change", () => {
            renderPatternFields(fieldsBox, patternSelect.value);
          });

          tr.querySelector(".btn-del").addEventListener("click", () =>
            tr.remove(),
          );
          tr.querySelector(".btn-dup").addEventListener("click", () => {
            const snapshot = collectDrugFromRow(tr);
            addDrugRow(snapshot);
          });
        }

        $("#btnAddDrug").addEventListener("click", () => addDrugRow());
        $("#btnClearDrugs").addEventListener(
          "click",
          () => (drugBody.innerHTML = ""),
        );
        addDrugRow(); // seed

        /* =========================
         * Coleta por linha
         * ========================= */
        function collectDrugFromRow(tr) {
          const name = tr.querySelector(".drug-name").value || "";
          const dose = tr.querySelector(".drug-dose").value || "";
          const via = tr.querySelector(".drug-via").value || "";
          const obs = tr.querySelector(".drug-obs").value || "";
          const pattern = tr.querySelector(".drug-pattern").value;
          const patternValues = {};
          tr.querySelectorAll(".drug-pattern-fields [data-key]").forEach(
            (el) => {
              patternValues[el.getAttribute("data-key")] = el.value.trim();
            },
          );
          return { name, dose, via, obs, pattern, patternValues };
        }

        function collectDrugs() {
          return [...drugBody.querySelectorAll("tr")]
            .map((tr) => collectDrugFromRow(tr))
            .filter((d) => d.name || d.dose || d.obs);
        }

        /* =========================
         * Issues (pendências)
         * ========================= */
        function clearIssues() {
          issuesList.innerHTML = "";
          issuesBox.style.display = "none";
        }
        function addIssue(msg) {
          const li = document.createElement("li");
          li.textContent = msg;
          issuesList.appendChild(li);
        }
        function showIssuesIfAny() {
          if (issuesList.children.length > 0) issuesBox.style.display = "";
        }

        /* =========================
         * Formatação de medicação
         * ========================= */
        function viaFormat(sigla, seen) {
          if (!sigla) return "(via não especificada)";
          if (!seen[sigla]) {
            seen[sigla] = true;
            return `(${sigla} — ${VIA_LABEL[sigla]})`;
          }
          return `(${sigla})`;
        }
        function buildMedString(d, seen) {
          const name = String(d.name || "").trim();
          const dose = normalizeDoseSpacing(String(d.dose || "").trim());
          const via = viaFormat(d.via || "", seen);
          return [name, dose].filter(Boolean).join(" ") + " " + via;
        }

        /* =========================
         * Geração de rótulos por fármaco
         * ========================= */
        function getValNum(obj, k) {
          return parsePositiveInt(obj[k]);
        }

        function generateLabelsForDrug(drug) {
          const key = drug.pattern;
          const p = drug.patternValues || {};
          const issues = [];
          let labels = [],
            composite = null;

          switch (key) {
            // Frequência fixa
            case "daily_n_days": {
              const n = getValNum(p, "n");
              if (!n)
                issues.push(`[${drug.name || "sem nome"}] Informe N (dias).`);
              else labels = labels_daily_n_days(n);
              break;
            }
            case "daily_n_weeks": {
              const n = getValNum(p, "n");
              if (!n)
                issues.push(
                  `[${drug.name || "sem nome"}] Informe N (semanas).`,
                );
              else labels = labels_daily_n_weeks(n);
              break;
            }
            case "weekly_n_weeks": {
              const n = getValNum(p, "n");
              if (!n)
                issues.push(
                  `[${drug.name || "sem nome"}] Informe N (semanas).`,
                );
              else labels = labels_weekly_n_weeks(n);
              break;
            }
            case "weekly_n_months": {
              const n = getValNum(p, "n");
              if (!n)
                issues.push(`[${drug.name || "sem nome"}] Informe N (meses).`);
              else {
                labels = labels_weekly_n_months(n);
                issues.push("Aproximação: 1 mês ≈ 4 semanas.");
              }
              break;
            }
            case "monthly_n_months": {
              const n = getValNum(p, "n");
              if (!n)
                issues.push(`[${drug.name || "sem nome"}] Informe N (meses).`);
              else labels = labels_monthly_n_months(n);
              break;
            }

            // Intervalos regulares
            case "every_x_days_n_doses": {
              const x = getValNum(p, "x"),
                n = getValNum(p, "n");
              if (!x || !n)
                issues.push(
                  `[${drug.name || "sem nome"}] Informe X (dias) e N (doses).`,
                );
              else labels = labels_every_x_days_n_doses(x, n);
              break;
            }
            case "every_x_days_y_weeks": {
              const x = getValNum(p, "x"),
                y = getValNum(p, "y");
              if (!x || !y)
                issues.push(
                  `[${drug.name || "sem nome"}] Informe X (dias) e Y (semanas).`,
                );
              else labels = labels_every_x_days_y_weeks(x, y);
              break;
            }
            case "every_x_days_y_months": {
              const x = getValNum(p, "x"),
                y = getValNum(p, "y");
              if (!x || !y)
                issues.push(
                  `[${drug.name || "sem nome"}] Informe X (dias) e Y (meses).`,
                );
              else {
                labels = labels_every_x_days_y_months(x, y);
                issues.push("Aproximação: 1 mês ≈ 30 dias.");
              }
              break;
            }
            case "every_x_weeks_y_months": {
              const x = getValNum(p, "x"),
                y = getValNum(p, "y");
              if (!x || !y)
                issues.push(
                  `[${drug.name || "sem nome"}] Informe X (semanas) e Y (meses).`,
                );
              else {
                labels = labels_every_x_weeks_y_months(x, y);
                issues.push("Aproximação: 1 mês ≈ 4 semanas.");
              }
              break;
            }
            case "every_x_months_n_doses": {
              const x = getValNum(p, "x"),
                n = getValNum(p, "n");
              if (!x || !n)
                issues.push(
                  `[${drug.name || "sem nome"}] Informe X (meses) e N (doses).`,
                );
              else labels = labels_every_x_months_n_doses(x, n);
              break;
            }

            // Doses totais
            case "n_doses_n_days": {
              const n = getValNum(p, "n"),
                per = getValNum(p, "p");
              if (!n || !per)
                issues.push(
                  `[${drug.name || "sem nome"}] Informe N (doses) e período (dias).`,
                );
              else labels = labels_n_doses_n_days(n, per);
              break;
            }
            case "n_doses_n_weeks": {
              const n = getValNum(p, "n"),
                per = getValNum(p, "p");
              if (!n || !per)
                issues.push(
                  `[${drug.name || "sem nome"}] Informe N (doses) e período (semanas).`,
                );
              else labels = labels_n_doses_n_weeks(n, per);
              break;
            }
            case "n_doses_3_months": {
              const n = getValNum(p, "n");
              if (!n)
                issues.push(`[${drug.name || "sem nome"}] Informe N (doses).`);
              else {
                labels = labels_n_doses_3_months(n);
                issues.push(
                  "Aproximação: 1 mês ≈ 30 dias (3 meses ≈ 90 dias).",
                );
              }
              break;
            }
            case "n_doses_n_months": {
              const n = getValNum(p, "n"),
                per = getValNum(p, "p");
              if (!n || !per)
                issues.push(
                  `[${drug.name || "sem nome"}] Informe N (doses) e período (meses).`,
                );
              else {
                labels = labels_n_doses_n_months(n, per);
                issues.push("Aproximação: 1 mês ≈ 30 dias.");
              }
              break;
            }

            // Dias específicos
            case "days_0_14_28": {
              labels = labels_days_0_14_28();
              break;
            }
            case "days_0_7_21_35": {
              labels = labels_days_0_7_21_35();
              break;
            }
            case "days_custom": {
              const list = p["list"];
              if (!list)
                issues.push(
                  `[${drug.name || "sem nome"}] Informe a lista de dias.`,
                );
              else labels = labels_days_custom(list);
              break;
            }

            // Avançadas
            case "daily_x_then_weekly_y": {
              const x = getValNum(p, "x"),
                y = getValNum(p, "y");
              if (!x || !y)
                issues.push(
                  `[${drug.name || "sem nome"}] Informe X (dias) e Y (semanas).`,
                );
              else {
                const comp = labels_daily_x_then_weekly_y(x, y);
                comp.blocks.forEach((b) => (labels = labels.concat(b.labels)));
              }
              break;
            }
            case "weekly_x_then_monthly_y": {
              const x = getValNum(p, "x"),
                y = getValNum(p, "y");
              if (!x || !y)
                issues.push(
                  `[${drug.name || "sem nome"}] Informe X (semanas) e Y (meses).`,
                );
              else {
                const comp = labels_weekly_x_then_monthly_y(x, y);
                comp.blocks.forEach((b) => (labels = labels.concat(b.labels)));
              }
              break;
            }
            case "every_x_days_until_n_doses": {
              const x = getValNum(p, "x"),
                n = getValNum(p, "n");
              if (!x || !n)
                issues.push(
                  `[${drug.name || "sem nome"}] Informe X (dias) e N (doses).`,
                );
              else labels = labels_every_x_days_until_n_doses(x, n);
              break;
            }
          }
          return { labels, issues };
        }

        /* =========================
         * Tabela: agregação por marco (rótulo)
         * ========================= */
        function clearResult() {
          resultBody.innerHTML = "";
        }
        function generateTable() {
          clearIssues();
          clearResult();
          let seenViaGlobal = {}; // para primeira ocorrência expandir via
          const drugs = collectDrugs();
          if (drugs.length === 0) addIssue("Nenhum fármaco informado.");

          // validações mínimas por fármaco
          drugs.forEach((d) => {
            if (!d.via)
              addIssue(`Via não especificada em: "${d.name || "(sem nome)"}".`);
            if (!d.dose)
              addIssue(
                `Dose incompleta/faltante em: "${d.name || "(sem nome)"}".`,
              );
          });

          // mapa label -> { meds:[], obs:Set }
          const bucket = new Map();

          drugs.forEach((d) => {
            const { labels, issues } = generateLabelsForDrug(d);
            issues.forEach(addIssue);
            if (labels.length === 0) return;

            labels.forEach((lab) => {
              if (!bucket.has(lab))
                bucket.set(lab, { meds: [], obs: new Set() });
              const entry = bucket.get(lab);

              // Monta string do medicamento com via (primeira ocorrência com descrição completa)
              const medStr = buildMedString(d, seenViaGlobal);
              entry.meds.push(medStr);

              // Observações: quebrar por | ou ; e evitar duplicata
              String(d.obs || "")
                .split(/(?:\s*\|\s*|\s*;\s*)/)
                .forEach((o) => {
                  const s = o.trim();
                  if (s) entry.obs.add(s);
                });
            });
          });

          if (bucket.size === 0) {
            addIssue(
              "Nenhuma linha gerada. Verifique os protocolos individuais.",
            );
            showIssuesIfAny();
            return;
          }

          // Ordenação estável por “Dia N” => extrai número; “Semana N” idem; caso contrário alfabético
          const labelsSorted = Array.from(bucket.keys()).sort((a, b) => {
            const dA = a.match(/Dia\s+(\d+)/);
            const dB = b.match(/Dia\s+(\d+)/);
            if (dA && dB) return Number(dA[1]) - Number(dB[1]);
            const sA = a.match(/Semana\s+(\d+)/);
            const sB = b.match(/Semana\s+(\d+)/);
            if (sA && sB) return Number(sA[1]) - Number(sB[1]);
            // misto: prioridade para "Dia", depois "Semana", depois alfabético
            if (dA && !dB) return -1;
            if (!dA && dB) return 1;
            if (sA && !sB) return -1;
            if (!sA && sB) return 1;
            return a.localeCompare(b, "pt-BR");
          });

          labelsSorted.forEach((lab, idx) => {
            const data = bucket.get(lab);
            const tr = document.createElement("tr");
            const medsStr = data.meds.join(" // ");
            const obsStr = Array.from(data.obs.values()).join(" | ");
            tr.innerHTML = `
              <td>
                <div class="check" role="checkbox" tabindex="0" aria-checked="false" aria-label="Marcar linha como aplicada"></div>
              </td>
              <td>${lab}</td>
              <td>${medsStr}</td>
              <td>${obsStr}</td>
            `;
            resultBody.appendChild(tr);
          });

          // ativa checkboxes
          resultBody.querySelectorAll(".check").forEach((el) => {
            el.addEventListener("click", () => toggleCheck(el));
            el.addEventListener("keydown", (e) => {
              if (e.key === " " || e.key === "Enter") {
                e.preventDefault();
                toggleCheck(el);
              }
            });
          });

          showIssuesIfAny();
        }

        function toggleCheck(el) {
          const curr = el.getAttribute("aria-checked") === "true";
          el.setAttribute("aria-checked", String(!curr));
        }

        // Botões principais
        $("#btnGenerate").addEventListener("click", generateTable);
        $("#btnPrint").addEventListener("click", () => window.print());
        $("#btnReset").addEventListener("click", () => {
          titleInput.value = "";
          syncTitle();
          drugBody.innerHTML = "";
          addDrugRow();
          clearIssues();
          clearResult();
        });

        /* =========================
         * Testes unitários simples (console)
         * ========================= */
        (function runTinyTests() {
          const assert = (cond, label) =>
            console[cond ? "log" : "error"](
              `[teste] ${label} -> ${cond ? "ok" : "falhou"}`,
            );
          assert(
            normalizeDoseSpacing("1.5mg") === "1,5 mg",
            "normaliza dose com ponto/unidade",
          );
          assert(
            JSON.stringify(labels_daily_n_days(3)) ===
              JSON.stringify([
                "Dose 1 (Dia 0)",
                "Dose 2 (Dia 1)",
                "Dose 3 (Dia 2)",
              ]),
            "labels_daily_n_days(3)",
          );
          const custom = labels_days_custom("0, 14; 28   60");
          assert(
            custom.length === 4 && custom[1].includes("14"),
            "labels_days_custom parsing",
          );
        })();
      })();
    </script>
  </body>
</html>
